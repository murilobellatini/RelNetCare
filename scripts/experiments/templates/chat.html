<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/neovis.js@1.5.0/dist/neovis.js"></script>
    <style>
      #chatbox {
        height: 500px;
        width: 100%;
        margin: 0 auto;
        background-color: #f5f5f5;
        border-radius: 4px;
        overflow-y: auto;
        padding: 10px;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .container {
        width: 50%; /* Adjust this as needed */
      }

      .card {
        width: 75%;
        margin: 10px auto;
      }

      .userText {
        text-align: right;
        background-color: #dff0d8;
        color: #3c763d;
      }

      #viz {
        width: 100%;
        height: 500px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="chatbox">
        <!-- Chat history will be dynamically populated here -->
      </div>
      <div class="input-group mb-3">
        <input
          id="textInput"
          type="text"
          class="form-control"
          placeholder="Type a message"
          aria-label="Recipient's username"
          aria-describedby="button-addon2"
        />
        <div class="input-group-append">
          <button
            class="btn btn-outline-success"
            type="button"
            id="button-addon2"
            onclick="getBotResponse()"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <div>
        <button
          class="btn btn-primary"
          type="button"
          data-toggle="collapse"
          data-target="#collapseExample"
          aria-expanded="false"
          aria-controls="collapseExample"
        >
          Toggle Neo4j Graph
        </button>
        <div class="collapse" id="collapseExample">
          <div class="card card-body">
            <div id="viz"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function getBotResponse() {
        var rawText = $("#textInput").val();
        // Check if the input is empty
        if (rawText.trim() === "") {
          return; // If it's empty, return immediately, don't proceed further
        }
        var userHtml =
          '<div class="card userText"><div class="card-body">' +
          rawText +
          "</div></div>";
        $("#textInput").val("");
        $("#chatbox").append(userHtml);
        document.getElementById("chatbox").scrollTop =
          document.getElementById("chatbox").scrollHeight;
        $.get("/get", { msg: rawText }).done(function (data) {
          var botHtml =
            '<div class="card botText"><div class="card-body">' +
            data +
            "</div></div>";
          $("#chatbox").append(botHtml);
          document.getElementById("chatbox").scrollTop =
            document.getElementById("chatbox").scrollHeight;
        });
      }
      $("#textInput").keypress(function (e) {
        if (e.which == 13) {
          getBotResponse();
        }
      });
    </script>
    <script>
      function draw() {
        var config = {
            container_id: "viz",
            server_url: "bolt://localhost:7687",
            server_user: "neo4j",
            server_password: "haha1234",
            labels: {
              "Entity": {
                "caption": "name",
              },
              "Dialogue": {
                "caption": "id",
              },
              "Dataset": {
                  "caption": false,
              }
            },
            relationships: {
              "RELATION": {
                "thickness": "count",
                "caption": "type"
              },
              "CONTAINS": {
                "thickness": "count",
                "caption": false,
              }
            },
            arrows: true,
            initial_cypher: "MATCH (n)-[r]->(m) WHERE NOT n:Dataset AND NOT m:Dataset RETURN n,r,m",
        };

          viz = new NeoVis.default(config);
          viz.render();
        }

        $(document).ready(function() {
          draw();
          var history = {{ history|tojson|safe }};
          history.forEach(function(message) {
            var messageHtml = '<div class="card ' + (message.role == 'system' ? 'botText' : 'userText') + '"><div class="card-body">' + message.content + '</div></div>';
            $("#chatbox").append(messageHtml);
          });
          document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight;
        });
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  </body>
</html>
