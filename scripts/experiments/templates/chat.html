<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/neovis.js@1.5.0/dist/neovis.js"></script>
    <style>
      #chatbox {
        height: 300px;
        width: 100%;
        margin: 0 auto;
        background-color: #f5f5f5;
        border-radius: 4px;
        overflow-y: auto;
        padding: 10px;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .container {
        width: 50%;
      }

      .card {
        width: 75%;
        margin: 0.01rem auto;
      }

      .userText {
        text-align: right;
        background-color: #dff0d8;
        color: #3c763d;
      }

      #graph {
        width: 100%; /* Changed from 120% to 100% */
      }

      #graph .card {
        width: 100%; /* Add this to make the card inside #graph take full width */
      }

      #viz {
        width: 100%;
        height: 450px;
      }

      .botText .card-body,
      .userText .card-body {
        padding: 10px; /* Adjust this value to your liking */
      }

      .botText p small,
      .userText p small {
        font-size: 0.7rem; /* Adjust this value to your liking */
        font-style: italic;
      }

      .botText {
        margin-right: 15%; /* Adjust this value to your liking */
      }

      .userText {
        margin-left: 15%; /* Adjust this value to your liking */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="text-center">
        <h1>Chat With {{ bot_name }}</h1>
        <small class="text-muted" style="font-style: italic"
          ><i class="fas fa-user"></i> <strong>User</strong>: {{ user_name
          }}</small
        >
      </div>
      <div id="chatbox">
        <!-- Chat history will be dynamically populated here -->
      </div>
      <div class="input-group mb-3">
        <input
          id="textInput"
          type="text"
          class="form-control"
          placeholder="Type a message"
          aria-label="Recipient's username"
          aria-describedby="button-addon2"
        />
        <div class="input-group-append">
          <button
            class="btn btn-outline-success"
            type="button"
            id="button-addon2"
            onclick="getBotResponse()"
            data-toggle="tooltip"
            data-placement="right"
            title="Send"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <div id="graph">
        <div class="row mb-3 align-items-center">
          <div class="col-lg-6">
            <div class="btn-group" role="group" aria-label="User options">
              <button
                class="btn btn-primary"
                type="button"
                data-toggle="collapse"
                data-target="#collapseExample"
                aria-expanded="true"
                aria-controls="collapseExample"
              >
                <span
                  data-toggle="tooltip"
                  data-placement="top"
                  title="Show/hide user graph"
                >
                  <i class="fas fa-eye"></i>

                  User Graph
                </span>
              </button>

              <button
                class="btn btn-outline-primary"
                type="button"
                id="button-addon3"
                onclick="getProactiveResponse()"
                data-toggle="tooltip"
                data-placement="top"
                title="Generate proactive question"
              >
                <i class="fas fa-question-circle"></i> Proactive Question
              </button>

              <!-- Your new button for archiving -->
              <button
                class="btn btn-outline-danger"
                type="button"
                id="button-addon4"
                onclick="archiveDialogue()"
                data-toggle="tooltip"
                data-placement="top"
                title="Archive chat history"
              >
                <i class="fas fa-archive"></i> Archive History
              </button>
            </div>
          </div>

          <div class="col-lg-6 text-right">
            <div class="d-inline-block mr-3">
              <div class="custom-control custom-switch">
                <input
                  type="checkbox"
                  class="custom-control-input"
                  id="toggleDialogue"
                  onchange="draw()"
                />
                <label class="custom-control-label" for="toggleDialogue"
                  >Show Dialogue Nodes</label
                >
              </div>
            </div>

            <div class="d-inline-block">
              <div class="custom-control custom-switch">
                <input
                  type="checkbox"
                  class="custom-control-input"
                  id="toggleDebug"
                />
                <label class="custom-control-label" for="toggleDebug"
                  >Toggle Debug Mode</label
                >
              </div>
            </div>
          </div>
        </div>

        <div class="collapse show" id="collapseExample">
          <div class="card">
            <div id="viz"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function getBotResponse() {
        var rawText = $("#textInput").val();
        var debugMode = $("#toggleDebug").is(":checked"); // Check if debug mode is enabled

        // Check if the input is empty
        if (rawText.trim() === "") {
          return; // If it's empty, return immediately, don't proceed further
        }

        appendMessage("user", Date.now() / 1000, rawText);
        $("#textInput").val("");

        $.get("/get", { msg: rawText, debug: debugMode }).done(function (data) {
          appendMessage("system", Date.now() / 1000, data);
          draw(); // Rerender the graph after each message
        });
      }
      $("#textInput").keypress(function (e) {
        if (e.which == 13) {
          getBotResponse();
        }
      });
    </script>
    <script>
        function draw() {
          var showDialogue = document.getElementById('toggleDialogue').checked;

          var initial_cypher = "MATCH (n)-[r]->(m) WHERE NOT n:Dataset AND NOT m:Dataset";
          if (!showDialogue) {
              initial_cypher += " AND NOT n:Dialogue AND NOT m:Dialogue";
          }
          initial_cypher += " RETURN n,r,m";

          var config = {
              container_id: "viz",
              server_url: "bolt://localhost:7687",
              server_user: "neo4j",
              server_password: "haha1234",
              labels: {
                "Entity": {
                  "caption": "name",
                },
                "Dialogue": {
                  "caption": "id",
                  "size": 0.5
                },
                "Dataset": {
                    "caption": false,
                }
              },
              relationships: {
                "RELATION": {
                  "thickness": "count",
                  "caption": "type"
                },
                "CONTAINS": {
                  "thickness": "count",
                  "caption": false,
                }
              },
              arrows: true,
              initial_cypher: initial_cypher,
              physics: {
                "barnesHut": {
                  "centralGravity": 0.00001,
                  "springLength": 100,
                  "springConstant": 0.5,
                  "damping": 0.09,
                  "avoidOverlap": 0.001
                },
                "minVelocity": 0.75
              },

          };



          viz = new NeoVis.default(config);
          viz.render();
      }

          $(document).ready(function() {
            draw();
            var history = {{ history|tojson|safe }};
            history.forEach(function(message) {
              appendMessage(message.role, message.timestamp, message.content);
            });
            document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight;
          });
    </script>

    <script>
      function getProactiveResponse() {
        var debugMode = $("#toggleDebug").is(":checked"); // Check if debug mode is enabled
        $.get("/proactive", { debug: debugMode }).done(function (data) {
          appendMessage("system", Date.now() / 1000, data);
          draw(); // Rerender the graph after each message
        });
      }

      function archiveDialogue() {
        $.get("/archive", function (data, status) {
          clearChatbox();
          draw();
        });
      }
    </script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip();
      });
      // define global JS variables
      var botName = "{{ bot_name }}";
      var userName = "{{ user_name }}";

      function appendMessage(role, timestamp, content) {
        var messageHtml =
          '<div class="card ' +
          (role == "system" ? "botText" : "userText") +
          '"><div class="card-body" style="padding-bottom: 0.05rem; padding-top: 0.2rem;">' + // Added inline CSS here
          (timestamp
            ? '<p style="margin-bottom: 10px;" ><small class="message-metadata" ><strong>' + // Added inline CSS here
              (role == "system"
                ? '<i class="fas fa-robot"></i>  '
                : '<i class="fas fa-user"></i>  ') +
              (role == "system" ? botName : userName) +
              "</strong> @ " +
              new Date(timestamp * 1000).toLocaleString() +
              "</small></br>"
            : "") +
          content +
          "</div></div></p>";
        $("#chatbox").append(messageHtml);
        document.getElementById("chatbox").scrollTop =
          document.getElementById("chatbox").scrollHeight;
      }

      function clearChatbox() {
        var chatbox = document.getElementById("chatbox");

        // Remove all child elements
        while (chatbox.firstChild) {
          chatbox.firstChild.remove();
        }
      }
    </script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  </body>
</html>
